import React, { useState, useEffect } from 'react';
import { Table, Card, Button, Tag, Space, Input, Select, DatePicker, message, Modal, Form, InputNumber, Drawer, Dropdown, Col, Row, List, Typography, Divider } from 'antd';
import type { MenuProps } from 'antd';
import { PlusOutlined, SearchOutlined, DollarOutlined, SendOutlined, CloseCircleOutlined, EditOutlined, MoreOutlined, DeleteOutlined, ShoppingCartOutlined } from '@ant-design/icons';
import axios from 'axios';
import API from '@/common/api';
import dayjs from 'dayjs';

const { RangePicker } = DatePicker;
const { Option } = Select;
const { Text, Title } = Typography;

interface Invoice {
  id: number;
  number: string;
  user_id: number;
  user?: { id: number; name: string; email: string };
  status: 'unpaid' | 'paid' | 'cancelled' | 'refunded';
  subtotal: number;
  tax_total: number;
  total: number;
  credit_applied: number;
  created_at: string;
  due_date: string | null;
  paid_at: string | null;
  notes?: string;
}

interface CartItem {
  product_id: number;
  product_name: string;
  product_type: string;
  billing_cycle: string;
  billing_cycle_display: string;
  unit_price: number;
  setup_fee: number;
  qty: number;
  description: string;
}

const InvoiceList: React.FC = () => {
  const [invoices, setInvoices] = useState<Invoice[]>([]);
  const [loading, setLoading] = useState(false);
  const [pagination, setPagination] = useState({ current: 1, pageSize: 20, total: 0 });
  const [filters, setFilters] = useState<any>({});
  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [isPaymentModalOpen, setIsPaymentModalOpen] = useState(false);
  const [selectedInvoice, setSelectedInvoice] = useState<Invoice | null>(null);
  const [clients, setClients] = useState<Array<{ value: number; label: string }>>([]);
  const [products, setProducts] = useState<any[]>([]);
  const [filteredProducts, setFilteredProducts] = useState<any[]>([]);
  const [productSearchText, setProductSearchText] = useState('');
  const [cart, setCart] = useState<CartItem[]>([]);
  const [selectedUserId, setSelectedUserId] = useState<number | null>(null);
  const [dueDate, setDueDate] = useState<any>(null);
  const [notes, setNotes] = useState('');
  const [isMobile, setIsMobile] = useState(false);
  const [form] = Form.useForm();
  const [editForm] = Form.useForm();
  const [paymentForm] = Form.useForm();

  // Detect mobile screen size
  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
    };
    
    checkMobile();
    window.addEventListener('resize', checkMobile);
    
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  useEffect(() => {
    fetchInvoices();
    fetchClients();
    fetchProducts();
  }, [pagination.current, filters]);

  const fetchClients = async () => {
    try {
      const response = await axios.post(API.congNoUsers);
      // API trả về { status_code, message, data: { datas: [...] } }
      const users = response.data?.data?.datas || [];
      setClients(users.map((u: any) => ({ value: u.id, label: `${u.name} (${u.phone || ''})` })));
    } catch (error) {
      console.error('Failed to fetch clients:', error);
    }
  };

  const fetchProducts = async () => {
    try {
      const response = await axios.get('/aio/api/whmcs/products');
      // Handle different response structures
      let productsData = response.data;
      
      // If response has data property, use it
      if (productsData && productsData.data) {
        productsData = productsData.data;
      }
      
      // Ensure it's an array
      if (!Array.isArray(productsData)) {
        productsData = [];
      }
      
      setProducts(productsData);
    } catch (error) {
      console.error('Failed to fetch products:', error);
      setProducts([]); // Set empty array on error
    }
  };

  const fetchInvoices = async () => {
    setLoading(true);
    try {
      const response = await axios.get('/aio/api/whmcs/invoices', {
        params: {
          page: pagination.current,
          per_page: pagination.pageSize,
          ...filters,
        },
      });
      setInvoices(response.data.data);
      setPagination({ ...pagination, total: response.data.total });
    } catch (error) {
      message.error('Không thể tải danh sách hóa đơn');
    } finally {
      setLoading(false);
    }
  };

  const handleCreateInvoice = async (values: any) => {
    try {
      // Transform cart items to API format
      const items = cart.map(item => ({
        product_id: item.product_id,
        description: item.description,
        type: 'product',
        billing_cycle: item.billing_cycle,
        qty: item.qty,
        unit_price: item.unit_price,
        setup_fee: item.setup_fee || 0,
      }));

      const payload = {
        user_id: selectedUserId,
        items: items,
        due_date: dueDate ? dayjs(dueDate).format('YYYY-MM-DD') : null,
        notes: notes || null,
      };

      await axios.post('/aio/api/whmcs/invoices', payload);
      message.success('Tạo hóa đơn thành công');
      setIsCreateModalOpen(false);
      resetCreateForm();
      fetchInvoices();
    } catch (error: any) {
      message.error(error.response?.data?.message || 'Không thể tạo hóa đơn');
    }
  };

  const resetCreateForm = () => {
    setCart([]);
    setSelectedUserId(null);
    setDueDate(null);
    setNotes('');
    setProductSearchText('');
  };

  const addToCart = (product: any, pricing: any) => {
    const existingItem = cart.find(
      item => item.product_id === product.id && item.billing_cycle === pricing.cycle
    );

    if (existingItem) {
      // Increase quantity
      setCart(cart.map(item =>
        item.product_id === product.id && item.billing_cycle === pricing.cycle
          ? { ...item, qty: item.qty + 1 }
          : item
      ));
    } else {
      // Add new item
      const newItem: CartItem = {
        product_id: product.id,
        product_name: product.name,
        product_type: product.type,
        billing_cycle: pricing.cycle,
        billing_cycle_display: pricing.cycle_display,
        unit_price: pricing.price,
        setup_fee: pricing.setup_fee || 0,
        qty: 1,
        description: `${product.name} - ${pricing.cycle_display}`,
      };
      setCart([...cart, newItem]);
    }
    message.success('Đã thêm vào giỏ hàng');
  };

  const removeFromCart = (index: number) => {
    setCart(cart.filter((_, i) => i !== index));
  };

  const updateCartItemQty = (index: number, qty: number) => {
    if (qty < 1) return;
    setCart(cart.map((item, i) => i === index ? { ...item, qty } : item));
  };

  const calculateSubtotal = () => {
    return cart.reduce((sum, item) => sum + (item.unit_price * item.qty) + item.setup_fee, 0);
  };

  const calculateTotal = () => {
    return calculateSubtotal(); // Add tax logic here if needed
  };

  // Filter products based on search
  useEffect(() => {
    if (productSearchText) {
      const filtered = products.filter(p =>
        p.name.toLowerCase().includes(productSearchText.toLowerCase()) ||
        p.type.toLowerCase().includes(productSearchText.toLowerCase())
      );
      setFilteredProducts(filtered);
    } else {
      setFilteredProducts(products);
    }
  }, [productSearchText, products]);

  const handleCreateInvoiceOld = async (values: any) => {
    try {
      await axios.post('/aio/api/whmcs/invoices', values);
      message.success('Tạo hóa đơn thành công');
      setIsCreateModalOpen(false);
      form.resetFields();
      fetchInvoices();
    } catch (error: any) {
      message.error(error.response?.data?.message || 'Không thể tạo hóa đơn');
    }
  };

  const handleUpdateInvoice = async (values: any) => {
    if (!selectedInvoice) return;
    
    try {
      await axios.put(`/aio/api/whmcs/invoices/${selectedInvoice.id}`, values);
      message.success('Cập nhật hóa đơn thành công');
      setIsEditModalOpen(false);
      editForm.resetFields();
      setSelectedInvoice(null);
      fetchInvoices();
    } catch (error: any) {
      message.error(error.response?.data?.message || 'Không thể cập nhật hóa đơn');
    }
  };

  const handleRecordPayment = async (values: any) => {
    if (!selectedInvoice) return;
    
    try {
      await axios.post(`/aio/api/whmcs/invoices/${selectedInvoice.id}/payment`, values);
      message.success('Ghi nhận thanh toán thành công');
      setIsPaymentModalOpen(false);
      paymentForm.resetFields();
      setSelectedInvoice(null);
      fetchInvoices();
    } catch (error: any) {
      message.error(error.response?.data?.message || 'Không thể ghi nhận thanh toán');
    }
  };

  const handleCancelInvoice = (invoice: Invoice) => {
    Modal.confirm({
      title: 'Hủy hóa đơn',
      content: `Bạn có chắc muốn hủy hóa đơn ${invoice.number}?`,
      onOk: async () => {
        try {
          await axios.post(`/aio/api/whmcs/invoices/${invoice.id}/cancel`, {
            reason: 'Cancelled by admin',
          });
          message.success('Hủy hóa đơn thành công');
          fetchInvoices();
        } catch (error: any) {
          message.error(error.response?.data?.message || 'Không thể hủy hóa đơn');
        }
      },
    });
  };

  const handleSendReminder = async (invoice: Invoice) => {
    try {
      await axios.post(`/aio/api/whmcs/invoices/${invoice.id}/send-reminder`, {
        type: 'first',
      });
      message.success('Đã gửi email nhắc nhở');
    } catch (error) {
      message.error('Không thể gửi email');
    }
  };

  const statusColors: Record<string, string> = {
    unpaid: 'warning',
    paid: 'success',
    cancelled: 'default',
    refunded: 'processing',
  };

  const statusLabels: Record<string, string> = {
    unpaid: 'Chưa thanh toán',
    paid: 'Đã thanh toán',
    cancelled: 'Đã hủy',
    refunded: 'Đã hoàn tiền',
  };

  const columns = [
    {
      title: 'Số hóa đơn',
      dataIndex: 'number',
      key: 'number',
      render: (text: string) => <strong>{text}</strong>,
    },
    {
      title: 'Khách hàng',
      dataIndex: ['user', 'name'],
      key: 'user',
      render: (_: any, record: any) => record.user?.name || '-',
    },
    {
      title: 'Trạng thái',
      dataIndex: 'status',
      key: 'status',
      render: (status: string) => (
        <Tag color={statusColors[status]}>{statusLabels[status]}</Tag>
      ),
    },
    {
      title: 'Tổng tiền',
      dataIndex: 'total',
      key: 'total',
      render: (total: number) => total ? `${Number(total).toLocaleString()} VNĐ` : '0 VNĐ',
    },
    {
      title: 'Ngày tạo',
      dataIndex: 'created_at',
      key: 'created_at',
      render: (date: string) => date ? dayjs(date).format('DD/MM/YYYY HH:mm') : '-',
    },
    {
      title: 'Hạn thanh toán',
      dataIndex: 'due_date',
      key: 'due_date',
      render: (date: string, record: Invoice) => {
        if (!date) return '-';
        const isOverdue = dayjs(date).isBefore(dayjs()) && record.status === 'unpaid';
        return (
          <span style={{ color: isOverdue ? 'red' : 'inherit' }}>
            {dayjs(date).format('DD/MM/YYYY')}
          </span>
        );
      },
    },
    {
      title: 'Thao tác',
      key: 'actions',
      width: 120,
      render: (_: any, record: Invoice) => {
        const menuItems: MenuProps['items'] = [
          {
            key: 'edit',
            label: 'Sửa',
            icon: <EditOutlined />,
            onClick: () => {
              setSelectedInvoice(record);
              editForm.setFieldsValue({
                user_id: record.user_id,
                status: record.status,
                due_date: record.due_date ? dayjs(record.due_date) : null,
                notes: record.notes,
              });
              setIsEditModalOpen(true);
            },
          },
        ];

        // Chỉ thêm các action này nếu invoice chưa thanh toán
        if (record.status === 'unpaid') {
          menuItems.push(
            {
              key: 'payment',
              label: 'Thanh toán',
              icon: <DollarOutlined />,
              onClick: () => {
                setSelectedInvoice(record);
                setIsPaymentModalOpen(true);
              },
            },
            {
              key: 'reminder',
              label: 'Nhắc nhở',
              icon: <SendOutlined />,
              onClick: () => handleSendReminder(record),
            },
            {
              type: 'divider',
            },
            {
              key: 'cancel',
              label: 'Hủy hóa đơn',
              icon: <CloseCircleOutlined />,
              danger: true,
              onClick: () => handleCancelInvoice(record),
            }
          );
        }

        return (
          <Dropdown menu={{ items: menuItems }} trigger={['click']}>
            <Button size="small" icon={<MoreOutlined />}>
              Thao tác
            </Button>
          </Dropdown>
        );
      },
    },
  ];

  return (
    <div className={isMobile ? "p-2" : "p-6"}>
      <Card
        title={
          <div style={{ fontSize: isMobile ? '16px' : '20px', fontWeight: 600 }}>
            Quản lý Hóa đơn WHMCS
          </div>
        }
        extra={
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => setIsCreateModalOpen(true)}
            size={isMobile ? 'middle' : 'large'}
          >
            {isMobile ? 'Tạo mới' : 'Tạo hóa đơn mới'}
          </Button>
        }
      >
        {/* Filters - Responsive layout */}
        <Space 
          direction={isMobile ? 'vertical' : 'horizontal'} 
          style={{ marginBottom: 16, width: isMobile ? '100%' : 'auto' }} 
          wrap
        >
          <Input
            placeholder="Tìm kiếm số hóa đơn"
            prefix={<SearchOutlined />}
            style={{ width: isMobile ? '100%' : 250 }}
            onChange={(e) => setFilters({ ...filters, search: e.target.value })}
            allowClear
          />
          <Select
            placeholder="Trạng thái"
            style={{ width: isMobile ? '100%' : 150 }}
            onChange={(value) => setFilters({ ...filters, status: value })}
            allowClear
          >
            <Option value="unpaid">Chưa thanh toán</Option>
            <Option value="paid">Đã thanh toán</Option>
            <Option value="cancelled">Đã hủy</Option>
          </Select>
        </Space>

        <Table
          dataSource={invoices}
          columns={columns}
          loading={loading}
          rowKey="id"
          scroll={{ x: isMobile ? 800 : undefined }}
          pagination={{
            ...pagination,
            onChange: (page) => setPagination({ ...pagination, current: page }),
            pageSize: isMobile ? 10 : 20,
            showSizeChanger: !isMobile,
            size: isMobile ? 'small' : 'default',
          }}
          size={isMobile ? 'small' : 'middle'}
        />
      </Card>

      {/* Create Invoice Drawer - 2 Column Layout with Shopping Cart */}
      <Drawer
        title="Tạo hóa đơn mới"
        placement="right"
        width={isMobile ? '100%' : '90%'}
        open={isCreateModalOpen}
        onClose={() => {
          setIsCreateModalOpen(false);
          resetCreateForm();
        }}
        footer={
          <div style={{ textAlign: 'right' }}>
            <Space>
              <Button onClick={() => {
                setIsCreateModalOpen(false);
                resetCreateForm();
              }}>
                Hủy
              </Button>
              <Button 
                type="primary" 
                onClick={handleCreateInvoice}
                disabled={cart.length === 0 || !selectedUserId}
              >
                Tạo hóa đơn
              </Button>
            </Space>
          </div>
        }
      >
        <Row gutter={24}>
          {/* Left Column - Product List */}
          <Col xs={24} lg={14}>
            <Card 
              title="Danh sách sản phẩm/dịch vụ"
              size="small"
              style={{ marginBottom: 16 }}
            >
              <Input
                placeholder="Tìm kiếm sản phẩm..."
                prefix={<SearchOutlined />}
                value={productSearchText}
                onChange={(e) => setProductSearchText(e.target.value)}
                style={{ marginBottom: 16 }}
                allowClear
              />
              
              <div style={{ maxHeight: 'calc(100vh - 350px)', overflowY: 'auto' }}>
                <List
                  dataSource={filteredProducts}
                  locale={{ emptyText: 'Không tìm thấy sản phẩm' }}
                  renderItem={(product: any) => (
                    <List.Item
                      key={product.id}
                      style={{ 
                        padding: '12px',
                        cursor: 'pointer',
                        transition: 'background 0.3s',
                      }}
                      className="product-item"
                    >
                      <div style={{ width: '100%' }}>
                        <div style={{ 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          alignItems: 'flex-start',
                          marginBottom: 8 
                        }}>
                          <div style={{ flex: 1 }}>
                            <Text strong style={{ fontSize: 15 }}>
                              {product.name}
                            </Text>
                            <div>
                              <Tag color="blue" style={{ marginTop: 4 }}>
                                {product.type}
                              </Tag>
                            </div>
                          </div>
                        </div>
                        
                        {product.description && (
                          <Text type="secondary" style={{ fontSize: 13, display: 'block', marginBottom: 12 }}>
                            {product.description}
                          </Text>
                        )}
                        
                        {product.pricings && product.pricings.length > 0 && (
                          <div style={{ 
                            display: 'grid', 
                            gridTemplateColumns: isMobile ? '1fr' : 'repeat(auto-fill, minmax(200px, 1fr))',
                            gap: 8,
                            marginTop: 8
                          }}>
                            {product.pricings.map((pricing: any) => (
                              <Button
                                key={pricing.id}
                                size="small"
                                type="default"
                                onClick={() => addToCart(product, pricing)}
                                style={{ 
                                  textAlign: 'left',
                                  height: 'auto',
                                  padding: '8px 12px',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  alignItems: 'flex-start'
                                }}
                              >
                                <Text strong style={{ fontSize: 12, color: '#1890ff' }}>
                                  {pricing.cycle_display}
                                </Text>
                                <Text style={{ fontSize: 13, color: '#000' }}>
                                  {pricing.price.toLocaleString('vi-VN')} VNĐ
                                </Text>
                                {pricing.setup_fee > 0 && (
                                  <Text type="secondary" style={{ fontSize: 11 }}>
                                    + Phí setup: {pricing.setup_fee.toLocaleString('vi-VN')} VNĐ
                                  </Text>
                                )}
                              </Button>
                            ))}
                          </div>
                        )}
                      </div>
                    </List.Item>
                  )}
                />
              </div>
            </Card>
          </Col>

          {/* Right Column - Order Info & Cart */}
          <Col xs={24} lg={10}>
            {/* Customer Selection */}
            <Card 
              title="Thông tin đơn hàng" 
              size="small"
              style={{ marginBottom: 16 }}
            >
              <div style={{ marginBottom: 12 }}>
                <Text strong>Khách hàng <Text type="danger">*</Text></Text>
                <Select
                  showSearch
                  placeholder="Chọn khách hàng"
                  optionFilterProp="label"
                  value={selectedUserId}
                  onChange={setSelectedUserId}
                  filterOption={(input, option) =>
                    (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                  }
                  options={clients}
                  style={{ width: '100%', marginTop: 8 }}
                />
              </div>

              <div style={{ marginBottom: 12 }}>
                <Text strong>Hạn thanh toán</Text>
                <DatePicker 
                  value={dueDate}
                  onChange={setDueDate}
                  format="YYYY-MM-DD"
                  style={{ width: '100%', marginTop: 8 }} 
                  placeholder="Chọn ngày"
                />
              </div>

              <div>
                <Text strong>Ghi chú</Text>
                <Input.TextArea 
                  value={notes}
                  onChange={(e) => setNotes(e.target.value)}
                  rows={3}
                  placeholder="Ghi chú cho hóa đơn..."
                  style={{ marginTop: 8 }}
                />
              </div>
            </Card>

            {/* Shopping Cart */}
            <Card 
              title={
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  <ShoppingCartOutlined />
                  <span>Giỏ hàng ({cart.length})</span>
                </div>
              }
              size="small"
              style={{ marginBottom: 16 }}
            >
              {cart.length === 0 ? (
                <div style={{ textAlign: 'center', padding: '20px 0' }}>
                  <ShoppingCartOutlined style={{ fontSize: 48, color: '#d9d9d9' }} />
                  <div style={{ marginTop: 8, color: '#999' }}>
                    Chưa có sản phẩm nào
                  </div>
                  <Text type="secondary" style={{ fontSize: 12 }}>
                    Chọn sản phẩm từ danh sách bên trái
                  </Text>
                </div>
              ) : (
                <div style={{ maxHeight: 'calc(100vh - 600px)', overflowY: 'auto' }}>
                  <List
                    dataSource={cart}
                    renderItem={(item, index) => (
                      <List.Item
                        key={index}
                        style={{ padding: '12px 0' }}
                        actions={[
                          <Button
                            key="delete"
                            type="text"
                            danger
                            size="small"
                            icon={<DeleteOutlined />}
                            onClick={() => removeFromCart(index)}
                          />
                        ]}
                      >
                        <List.Item.Meta
                          title={
                            <div>
                              <Text strong style={{ fontSize: 14 }}>
                                {item.product_name}
                              </Text>
                              <div>
                                <Tag size="small" color="blue" style={{ marginTop: 4 }}>
                                  {item.billing_cycle_display}
                                </Tag>
                              </div>
                            </div>
                          }
                          description={
                            <div style={{ marginTop: 8 }}>
                              <div style={{ marginBottom: 4 }}>
                                <Text style={{ fontSize: 13 }}>
                                  Đơn giá: {item.unit_price.toLocaleString('vi-VN')} VNĐ
                                </Text>
                              </div>
                              {item.setup_fee > 0 && (
                                <div style={{ marginBottom: 4 }}>
                                  <Text type="secondary" style={{ fontSize: 12 }}>
                                    Phí setup: {item.setup_fee.toLocaleString('vi-VN')} VNĐ
                                  </Text>
                                </div>
                              )}
                              <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginTop: 8 }}>
                                <Text style={{ fontSize: 12 }}>Số lượng:</Text>
                                <InputNumber
                                  size="small"
                                  min={1}
                                  value={item.qty}
                                  onChange={(value) => updateCartItemQty(index, value || 1)}
                                  style={{ width: 70 }}
                                />
                              </div>
                              <div style={{ marginTop: 8 }}>
                                <Text strong style={{ fontSize: 13, color: '#1890ff' }}>
                                  Thành tiền: {((item.unit_price * item.qty) + item.setup_fee).toLocaleString('vi-VN')} VNĐ
                                </Text>
                              </div>
                            </div>
                          }
                        />
                      </List.Item>
                    )}
                  />
                </div>
              )}
            </Card>

            {/* Total Summary */}
            {cart.length > 0 && (
              <Card size="small">
                <div style={{ marginBottom: 8 }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                    <Text>Tạm tính:</Text>
                    <Text>{calculateTotal().toLocaleString('vi-VN')} VNĐ</Text>
                  </div>
                </div>
                <Divider style={{ margin: '12px 0' }} />
                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                  <Text strong style={{ fontSize: 16 }}>Tổng cộng:</Text>
                  <Text strong style={{ fontSize: 18, color: '#ff4d4f' }}>
                    {calculateTotal().toLocaleString('vi-VN')} VNĐ
                  </Text>
                </div>
              </Card>
            )}
          </Col>
        </Row>

        {/* Custom CSS for hover effect */}
        <style>{`
          .product-item:hover {
            background-color: #f5f5f5;
          }
        `}</style>
      </Drawer>

      {/* Payment Modal/Drawer */}
            <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '2fr 1fr', gap: '16px' }}>
              <Form.Item
                label="Khách hàng"
                name="user_id"
                rules={[{ required: true, message: 'Vui lòng chọn khách hàng' }]}
              >
                <Select
                  showSearch
                  placeholder="Chọn khách hàng"
                  optionFilterProp="label"
                  filterOption={(input, option) =>
                    (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                  }
                  options={clients}
                  style={{ width: '100%' }}
                />
              </Form.Item>

              <Form.Item label="Hạn thanh toán" name="due_date">
                <DatePicker style={{ width: '100%' }} format="YYYY-MM-DD" />
              </Form.Item>
            </div>

            <Form.List name="items">
              {(fields, { add, remove }) => (
                <>
                  {fields.map(({ key, name, ...restField }) => (
                    <div key={key} style={{ 
                      padding: isMobile ? '12px' : '16px', 
                      marginBottom: '16px', 
                      border: '1px solid #d9d9d9', 
                      borderRadius: '4px',
                      backgroundColor: '#fafafa'
                    }}>
                      <div style={{ 
                        display: 'grid', 
                        gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', 
                        gap: '16px', 
                        marginBottom: '16px' 
                      }}>
                      <Form.Item
                        {...restField}
                        label="Sản phẩm/Dịch vụ"
                        name={[name, 'product_id']}
                        rules={[{ required: true, message: 'Chọn sản phẩm' }]}
                      >
                        <Select
                          placeholder="Chọn sản phẩm"
                          onChange={(productId) => {
                            const product = products.find(p => p.id === productId);
                            if (product && product.pricings && product.pricings.length > 0) {
                              // Clear billing cycle khi đổi product
                              const items = form.getFieldValue('items');
                              items[name].billing_cycle = undefined;
                              items[name].unit_price = undefined;
                              items[name].setup_fee = undefined;
                              form.setFieldsValue({ items });
                            }
                          }}
                        >
                          {Array.isArray(products) && products.map(product => (
                            <Option key={product.id} value={product.id}>
                              {product.name} ({product.type})
                            </Option>
                          ))}
                        </Select>
                      </Form.Item>

                      <Form.Item
                        {...restField}
                        label="Kỳ thanh toán"
                        name={[name, 'billing_cycle']}
                        rules={[{ required: true, message: 'Chọn kỳ thanh toán' }]}
                      >
                        <Select
                          placeholder="Chọn kỳ thanh toán"
                          onChange={(cycle) => {
                            const items = form.getFieldValue('items');
                            const productId = items[name].product_id;
                            const product = products.find(p => p.id === productId);
                            
                            if (product && product.pricings) {
                              const pricing = product.pricings.find((p: any) => p.cycle === cycle);
                              if (pricing) {
                                items[name].unit_price = pricing.price;
                                items[name].setup_fee = pricing.setup_fee || 0;
                                form.setFieldsValue({ items });
                              }
                            }
                          }}
                        >
                          {(() => {
                            const items = form.getFieldValue('items') || [];
                            const productId = items[name]?.product_id;
                            const product = products.find(p => p.id === productId);
                            
                            if (!product || !product.pricings) return null;
                            
                            return product.pricings.map((pricing: any) => (
                              <Option key={pricing.id} value={pricing.cycle}>
                                {pricing.cycle} - {Number(pricing.price).toLocaleString()} VNĐ
                              </Option>
                            ));
                          })()}
                        </Select>
                      </Form.Item>
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr 1fr', gap: '16px' }}>
                      <Form.Item
                        {...restField}
                        label="Mô tả"
                        name={[name, 'description']}
                        rules={[{ required: true, message: 'Nhập mô tả' }]}
                      >
                        <Input placeholder="Mô tả chi tiết" />
                      </Form.Item>

                      <Form.Item
                        {...restField}
                        label="Giá"
                        name={[name, 'unit_price']}
                        rules={[{ required: true, message: 'Nhập giá' }]}
                      >
                        <InputNumber 
                          placeholder="Giá" 
                          style={{ width: '100%' }}
                          formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                          parser={value => value!.replace(/\$\s?|(,*)/g, '')}
                        />
                      </Form.Item>

                      <Form.Item
                        {...restField}
                        label="Phí cài đặt"
                        name={[name, 'setup_fee']}
                        initialValue={0}
                      >
                        <InputNumber 
                          placeholder="Phí cài đặt" 
                          style={{ width: '100%' }}
                          formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                          parser={value => value!.replace(/\$\s?|(,*)/g, '')}
                        />
                      </Form.Item>

                      <Form.Item
                        {...restField}
                        label="Số lượng"
                        name={[name, 'qty']}
                        initialValue={1}
                        rules={[{ required: true, message: 'Nhập SL' }]}
                      >
                        <InputNumber 
                          placeholder="SL" 
                          min={1}
                          style={{ width: '100%' }}
                        />
                      </Form.Item>
                    </div>

                    <Button 
                      danger 
                      onClick={() => remove(name)}
                      style={{ marginTop: '8px' }}
                    >
                      Xóa item này
                    </Button>
                  </div>
                ))}
                <Form.Item>
                  <Button type="dashed" onClick={() => add()} block icon={<PlusOutlined />}>
                    Thêm item
                  </Button>
                </Form.Item>
              </>
            )}
          </Form.List>

          <Form.Item label="Ghi chú" name="notes">
            <Input.TextArea rows={3} />
          </Form.Item>
        </Form>
        </Drawer>
      ) : (
        <Modal
          title="Tạo hóa đơn mới"
          open={isCreateModalOpen}
          onCancel={() => {
            setIsCreateModalOpen(false);
            form.resetFields();
          }}
          onOk={() => form.submit()}
          width={1000}
        >
          <Form form={form} layout="vertical" onFinish={handleCreateInvoice}>
            {/* Khách hàng và Hạn thanh toán trên cùng 1 hàng */}
            <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '16px' }}>
              <Form.Item
                label="Khách hàng"
                name="user_id"
                rules={[{ required: true, message: 'Vui lòng chọn khách hàng' }]}
              >
                <Select
                  showSearch
                  placeholder="Chọn khách hàng"
                  optionFilterProp="label"
                  filterOption={(input, option) =>
                    (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                  }
                  options={clients}
                  style={{ width: '100%' }}
                />
              </Form.Item>

              <Form.Item label="Hạn thanh toán" name="due_date">
                <DatePicker style={{ width: '100%' }} format="YYYY-MM-DD" />
              </Form.Item>
            </div>

            <Form.List name="items">
              {(fields, { add, remove }) => (
                <>
                  {fields.map(({ key, name, ...restField }) => (
                    <div key={key} style={{ 
                      padding: '16px', 
                      marginBottom: '16px', 
                      border: '1px solid #d9d9d9', 
                      borderRadius: '4px',
                      backgroundColor: '#fafafa'
                    }}>
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                        <Form.Item
                          {...restField}
                          label="Sản phẩm/Dịch vụ"
                          name={[name, 'product_id']}
                          rules={[{ required: true, message: 'Chọn sản phẩm' }]}
                        >
                          <Select
                            placeholder="Chọn sản phẩm"
                            onChange={(productId) => {
                              const product = products.find(p => p.id === productId);
                              if (product && product.pricings && product.pricings.length > 0) {
                                const items = form.getFieldValue('items');
                                items[name].billing_cycle = undefined;
                                items[name].unit_price = undefined;
                                items[name].setup_fee = undefined;
                                form.setFieldsValue({ items });
                              }
                            }}
                          >
                            {Array.isArray(products) && products.map(product => (
                              <Option key={product.id} value={product.id}>
                                {product.name} ({product.type})
                              </Option>
                            ))}
                          </Select>
                        </Form.Item>

                        <Form.Item
                          {...restField}
                          label="Kỳ thanh toán"
                          name={[name, 'billing_cycle']}
                          rules={[{ required: true, message: 'Chọn kỳ thanh toán' }]}
                        >
                          <Select
                            placeholder="Chọn kỳ thanh toán"
                            onChange={(cycle) => {
                              const items = form.getFieldValue('items');
                              const productId = items[name].product_id;
                              const product = products.find(p => p.id === productId);
                              
                              if (product && product.pricings) {
                                const pricing = product.pricings.find((p: any) => p.cycle === cycle);
                                if (pricing) {
                                  items[name].unit_price = pricing.price;
                                  items[name].setup_fee = pricing.setup_fee || 0;
                                  form.setFieldsValue({ items });
                                }
                              }
                            }}
                          >
                            {(() => {
                              const items = form.getFieldValue('items');
                              if (!items || !items[name]) return null;
                              
                              const productId = items[name].product_id;
                              const product = products.find(p => p.id === productId);
                              
                              if (!product || !product.pricings) return null;
                              
                              return product.pricings.map((pricing: any) => (
                                <Option key={pricing.cycle} value={pricing.cycle}>
                                  {pricing.cycle_display} - {pricing.price.toLocaleString()} VNĐ
                                </Option>
                              ));
                            })()}
                          </Select>
                        </Form.Item>
                      </div>

                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px' }}>
                        <Form.Item
                          {...restField}
                          label="Đơn giá"
                          name={[name, 'unit_price']}
                          rules={[{ required: true, message: 'Nhập giá' }]}
                        >
                          <InputNumber 
                            placeholder="Đơn giá" 
                            style={{ width: '100%' }}
                            formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                            parser={value => value!.replace(/\$\s?|(,*)/g, '')}
                          />
                        </Form.Item>

                        <Form.Item
                          {...restField}
                          label="Phí cài đặt"
                          name={[name, 'setup_fee']}
                          initialValue={0}
                        >
                          <InputNumber 
                            placeholder="Phí cài đặt" 
                            style={{ width: '100%' }}
                            formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                            parser={value => value!.replace(/\$\s?|(,*)/g, '')}
                          />
                        </Form.Item>

                        <Form.Item
                          {...restField}
                          label="Số lượng"
                          name={[name, 'qty']}
                          initialValue={1}
                          rules={[{ required: true, message: 'Nhập SL' }]}
                        >
                          <InputNumber 
                            placeholder="SL" 
                            min={1}
                            style={{ width: '100%' }}
                          />
                        </Form.Item>
                      </div>

                      <Button 
                        danger 
                        onClick={() => remove(name)}
                        style={{ marginTop: '8px' }}
                      >
                        Xóa item này
                      </Button>
                    </div>
                  ))}
                  <Form.Item>
                    <Button type="dashed" onClick={() => add()} block icon={<PlusOutlined />}>
                      Thêm item
                    </Button>
                  </Form.Item>
                </>
              )}
            </Form.List>

            <Form.Item label="Ghi chú" name="notes">
              <Input.TextArea rows={3} />
            </Form.Item>
          </Form>
        </Modal>
      )}

      {/* Payment Modal/Drawer */}
      {isMobile ? (
        <Drawer
          title={`Thanh toán - ${selectedInvoice?.number}`}
          placement="bottom"
          height="70vh"
          open={isPaymentModalOpen}
          onClose={() => {
            setIsPaymentModalOpen(false);
            paymentForm.resetFields();
            setSelectedInvoice(null);
          }}
          footer={
            <Space style={{ width: '100%', justifyContent: 'flex-end' }}>
              <Button onClick={() => {
                setIsPaymentModalOpen(false);
                paymentForm.resetFields();
                setSelectedInvoice(null);
              }}>
                Hủy
              </Button>
              <Button type="primary" onClick={() => paymentForm.submit()}>
                Xác nhận
              </Button>
            </Space>
          }
        >
          <Form form={paymentForm} layout="vertical" onFinish={handleRecordPayment}>
            <Form.Item
              label="Số tiền"
              name="amount"
              rules={[{ required: true, message: 'Vui lòng nhập số tiền' }]}
            >
              <InputNumber
                style={{ width: '100%' }}
                formatter={(value) => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                parser={(value) => value!.replace(/\$\s?|(,*)/g, '')}
                addonAfter="VNĐ"
              />
            </Form.Item>

            <Form.Item
              label="Phương thức thanh toán"
              name="payment_method"
              rules={[{ required: true, message: 'Vui lòng chọn phương thức' }]}
            >
              <Select placeholder="Chọn phương thức">
                <Option value="bank_transfer">Chuyển khoản ngân hàng</Option>
                <Option value="vnpay">VNPay</Option>
                <Option value="momo">MoMo</Option>
                <Option value="cash">Tiền mặt</Option>
                <Option value="credit">Credit Balance</Option>
              </Select>
            </Form.Item>

            <Form.Item label="Mã giao dịch" name="transaction_id">
              <Input placeholder="Mã giao dịch (nếu có)" />
            </Form.Item>
          </Form>
        </Drawer>
      ) : (
        <Modal
          title={`Ghi nhận thanh toán - ${selectedInvoice?.number}`}
          open={isPaymentModalOpen}
          onCancel={() => {
            setIsPaymentModalOpen(false);
            paymentForm.resetFields();
            setSelectedInvoice(null);
          }}
          onOk={() => paymentForm.submit()}
        >
          <Form form={paymentForm} layout="vertical" onFinish={handleRecordPayment}>
          <Form.Item
            label="Số tiền"
            name="amount"
            rules={[{ required: true, message: 'Vui lòng nhập số tiền' }]}
          >
            <InputNumber
              style={{ width: '100%' }}
              formatter={(value) => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
              parser={(value) => value!.replace(/\$\s?|(,*)/g, '')}
              addonAfter="VNĐ"
            />
          </Form.Item>

          <Form.Item
            label="Phương thức thanh toán"
            name="payment_method"
            rules={[{ required: true, message: 'Vui lòng chọn phương thức' }]}
          >
            <Select placeholder="Chọn phương thức">
              <Option value="bank_transfer">Chuyển khoản ngân hàng</Option>
              <Option value="vnpay">VNPay</Option>
              <Option value="momo">MoMo</Option>
              <Option value="cash">Tiền mặt</Option>
              <Option value="credit">Credit Balance</Option>
            </Select>
          </Form.Item>

          <Form.Item label="Mã giao dịch" name="transaction_id">
            <Input placeholder="Mã giao dịch (nếu có)" />
          </Form.Item>
        </Form>
      </Modal>
      )}

      {/* Edit Invoice Modal/Drawer */}
      {isMobile ? (
        <Drawer
          title={`Sửa - ${selectedInvoice?.number}`}
          placement="bottom"
          height="80vh"
          open={isEditModalOpen}
          onClose={() => {
            setIsEditModalOpen(false);
            editForm.resetFields();
            setSelectedInvoice(null);
          }}
          footer={
            <Space style={{ width: '100%', justifyContent: 'flex-end' }}>
              <Button onClick={() => {
                setIsEditModalOpen(false);
                editForm.resetFields();
                setSelectedInvoice(null);
              }}>
                Hủy
              </Button>
              <Button type="primary" onClick={() => editForm.submit()}>
                Cập nhật
              </Button>
            </Space>
          }
        >
          <Form form={editForm} layout="vertical" onFinish={handleUpdateInvoice}>
            <Form.Item
              label="Khách hàng"
              name="user_id"
              rules={[{ required: true, message: 'Vui lòng chọn khách hàng' }]}
            >
              <Select
                showSearch
                placeholder="Chọn khách hàng"
                optionFilterProp="label"
                filterOption={(input, option) =>
                  (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                }
                options={clients}
                style={{ width: '100%' }}
              />
            </Form.Item>

            <Form.Item
              label="Trạng thái"
              name="status"
              rules={[{ required: true, message: 'Vui lòng chọn trạng thái' }]}
            >
              <Select placeholder="Chọn trạng thái">
                <Option value="unpaid">Chưa thanh toán</Option>
                <Option value="paid">Đã thanh toán</Option>
                <Option value="cancelled">Đã hủy</Option>
                <Option value="refunded">Đã hoàn tiền</Option>
              </Select>
            </Form.Item>

            <Form.Item label="Hạn thanh toán" name="due_date">
              <DatePicker style={{ width: '100%' }} format="YYYY-MM-DD" />
            </Form.Item>

            <Form.Item label="Ghi chú" name="notes">
              <Input.TextArea rows={3} placeholder="Ghi chú cho hóa đơn" />
            </Form.Item>
          </Form>
        </Drawer>
      ) : (
        <Modal
          title={`Sửa hóa đơn - ${selectedInvoice?.number}`}
          open={isEditModalOpen}
          onCancel={() => {
            setIsEditModalOpen(false);
            editForm.resetFields();
            setSelectedInvoice(null);
          }}
          onOk={() => editForm.submit()}
          width={800}
        >
          <Form form={editForm} layout="vertical" onFinish={handleUpdateInvoice}>
          <Form.Item
            label="Khách hàng"
            name="user_id"
            rules={[{ required: true, message: 'Vui lòng chọn khách hàng' }]}
          >
            <Select
              showSearch
              placeholder="Chọn khách hàng"
              optionFilterProp="label"
              filterOption={(input, option) =>
                (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
              }
              options={clients}
              style={{ width: '100%' }}
            />
          </Form.Item>

          <Form.Item
            label="Trạng thái"
            name="status"
            rules={[{ required: true, message: 'Vui lòng chọn trạng thái' }]}
          >
            <Select placeholder="Chọn trạng thái">
              <Option value="unpaid">Chưa thanh toán</Option>
              <Option value="paid">Đã thanh toán</Option>
              <Option value="cancelled">Đã hủy</Option>
              <Option value="refunded">Đã hoàn tiền</Option>
            </Select>
          </Form.Item>

          <Form.Item label="Hạn thanh toán" name="due_date">
            <DatePicker style={{ width: '100%' }} format="YYYY-MM-DD" />
          </Form.Item>

          <Form.Item label="Ghi chú" name="notes">
            <Input.TextArea rows={3} placeholder="Ghi chú cho hóa đơn" />
          </Form.Item>
        </Form>
      </Modal>
      )}
    </div>
  );
};

export default InvoiceList;
