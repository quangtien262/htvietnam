# WHMCS Invoice - New 2-Column Drawer for Creating Invoices

## TÃ³m táº¯t
Chuyá»ƒn tá»« Modal/Form truyá»n thá»‘ng sang Drawer layout 2 cá»™t vá»›i tráº£i nghiá»‡m tá»‘t hÆ¡n:
- **TrÃ¡i**: Danh sÃ¡ch sáº£n pháº©m/dá»‹ch vá»¥ cÃ³ search
- **Pháº£i**: ThÃ´ng tin Ä‘Æ¡n hÃ ng + giá» hÃ ng + tá»•ng tiá»n

## Layout Má»›i

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Táº¡o hÃ³a Ä‘Æ¡n má»›i                          [Há»§y] [Táº¡o HÄ]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DANH SÃCH Sáº¢N PHáº¨M (60%) â”‚  THÃ”NG TIN ÄÆ N (40%)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ” TÃ¬m kiáº¿m sáº£n pháº©m...   â”‚  ğŸ‘¤ KhÃ¡ch hÃ ng: [Select]      â”‚
â”‚                            â”‚  ğŸ“… Háº¡n TT: [DatePicker]      â”‚
â”‚  ğŸ“¦ Hosting Cloud          â”‚  ğŸ“ Ghi chÃº: [TextArea]       â”‚
â”‚     â”œâ”€ HÃ ng thÃ¡ng: 100K   â”‚                                â”‚
â”‚     â”‚  + Setup: 50K [+]   â”‚  ğŸ›’ Sáº¢N PHáº¨M ÄÃƒ CHá»ŒN (2)      â”‚
â”‚     â”œâ”€ HÃ ng nÄƒm: 1000K    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚     â”‚  + Setup: 0Ä‘   [+]  â”‚  â”‚ Hosting Cloud            â”‚ â”‚
â”‚                            â”‚  â”‚ â””â”€ HÃ ng thÃ¡ng            â”‚ â”‚
â”‚  ğŸ“¦ VPS Standard           â”‚  â”‚ ÄÆ¡n giÃ¡: 100,000         â”‚ â”‚
â”‚     â”œâ”€ ThÃ¡ng: 500K   [+]  â”‚  â”‚ Setup: 50,000            â”‚ â”‚
â”‚     â”œâ”€ NÄƒm: 5000K    [+]  â”‚  â”‚ SL: [2] â–¼                â”‚ â”‚
â”‚                            â”‚  â”‚ ThÃ nh tiá»n: 250,000 VNÄ  â”‚ â”‚
â”‚  ğŸ“¦ Domain .com            â”‚  â”‚                     [XÃ³a] â”‚ â”‚
â”‚     â”œâ”€ 1 nÄƒm: 300K   [+]  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                            â”‚  â”‚ VPS Standard             â”‚ â”‚
â”‚                            â”‚  â”‚ â””â”€ HÃ ng nÄƒm              â”‚ â”‚
â”‚                            â”‚  â”‚ ÄÆ¡n giÃ¡: 5,000,000       â”‚ â”‚
â”‚                            â”‚  â”‚ SL: [1] â–¼                â”‚ â”‚
â”‚                            â”‚  â”‚ ThÃ nh tiá»n: 5,000,000    â”‚ â”‚
â”‚                            â”‚  â”‚                     [XÃ³a] â”‚ â”‚
â”‚                            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                â”‚
â”‚                            â”‚  ğŸ’° TÃ“M Táº®T ÄÆ N HÃ€NG         â”‚
â”‚                            â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                            â”‚  Táº¡m tÃ­nh:      5,250,000 Ä‘ â”‚
â”‚                            â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                            â”‚  Tá»”NG Cá»˜NG:     5,250,000 Ä‘ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Features

### 1. **Drawer 90% Width**
```tsx
<Drawer
  placement="right"
  width={isMobile ? '100%' : '90%'}
  title="Táº¡o hÃ³a Ä‘Æ¡n má»›i"
>
```

### 2. **2-Column Layout**
```tsx
<Row gutter={16}>
  <Col xs={24} lg={14}>  {/* Product List 60% */}
  <Col xs={24} lg={10}>  {/* Order Info 40% */}
</Row>
```

### 3. **Product Search**
```tsx
<Input
  placeholder="TÃ¬m kiáº¿m sáº£n pháº©m..."
  prefix={<SearchOutlined />}
  value={productSearchText}
  onChange={(e) => setProductSearchText(e.target.value)}
/>
```

### 4. **Shopping Cart Pattern**
```tsx
const [cart, setCart] = useState<CartItem[]>([]);

const addToCart = (product, pricing) => {
  // Check if exists, increase qty
  // Else add new item
};
```

### 5. **Real-time Total Calculation**
```tsx
const calculateTotal = () => {
  return cart.reduce((sum, item) => 
    sum + (item.unit_price * item.qty) + item.setup_fee, 0
  );
};
```

## Component Structure

### State Management
```tsx
// Drawer state
const [isCreateDrawerOpen, setIsCreateDrawerOpen] = useState(false);

// Product filter
const [filteredProducts, setFilteredProducts] = useState([]);
const [productSearchText, setProductSearchText] = useState('');

// Shopping cart
const [cart, setCart] = useState<CartItem[]>([]);

// Order info
const [selectedUserId, setSelectedUserId] = useState(null);
const [dueDate, setDueDate] = useState(null);
const [notes, setNotes] = useState('');
```

### Cart Item Interface
```tsx
interface CartItem {
  product_id: number;
  product_name: string;
  product_type: string;
  billing_cycle: string;
  billing_cycle_display: string;
  unit_price: number;
  setup_fee: number;
  qty: number;
  description: string;
}
```

## User Flow

1. **Click "Táº¡o hÃ³a Ä‘Æ¡n má»›i"** â†’ Drawer opens 90% width
2. **Select Customer** (required) â†’ Enable product adding
3. **Search Products** â†’ Filter list real-time
4. **Click [+] on pricing** â†’ Add to cart
5. **Adjust quantity** â†’ Update cart item
6. **Remove items** â†’ Click [XÃ³a]
7. **Set due date & notes** â†’ Optional
8. **View total** â†’ Auto-calculated
9. **Click "Táº¡o hÃ³a Ä‘Æ¡n"** â†’ Submit

## Left Column - Product List

### Features
- âœ… Search by product name/type
- âœ… Display all products with pricings
- âœ… Each pricing has [+] button
- âœ… Show price + setup fee
- âœ… Responsive card layout
- âœ… Scrollable list

### Code
```tsx
<List
  dataSource={filteredProducts}
  renderItem={(product) => (
    <Card title={product.name}>
      <List
        dataSource={product.pricings}
        renderItem={(pricing) => (
          <List.Item
            actions={[
              <Button 
                icon={<PlusOutlined />}
                onClick={() => addToCart(product, pricing)}
              >
                ThÃªm
              </Button>
            ]}
          >
            <List.Item.Meta
              title={pricing.cycle_display}
              description={`${pricing.price.toLocaleString()} VNÄ`}
            />
          </List.Item>
        )}
      />
    </Card>
  )}
/>
```

## Right Column - Order Info

### Sections

#### 1. Customer & Date
```tsx
<Card>
  <Select 
    placeholder="Chá»n khÃ¡ch hÃ ng"
    value={selectedUserId}
    onChange={setSelectedUserId}
  />
  <DatePicker 
    value={dueDate}
    onChange={setDueDate}
  />
  <TextArea 
    value={notes}
    onChange={(e) => setNotes(e.target.value)}
  />
</Card>
```

#### 2. Cart Items
```tsx
<Card title="Sáº£n pháº©m Ä‘Ã£ chá»n">
  {cart.map((item, index) => (
    <List.Item
      actions={[
        <Button danger onClick={() => removeFromCart(index)}>
          XÃ³a
        </Button>
      ]}
    >
      <Meta
        title={item.product_name}
        description={
          <>
            ÄÆ¡n giÃ¡: {item.unit_price.toLocaleString()}
            SL: <InputNumber value={item.qty} onChange={...} />
            ThÃ nh tiá»n: {(item.unit_price * item.qty + item.setup_fee).toLocaleString()}
          </>
        }
      />
    </List.Item>
  ))}
</Card>
```

#### 3. Total Summary
```tsx
<Card style={{ backgroundColor: '#f5f5f5' }}>
  <div>Táº¡m tÃ­nh: {calculateSubtotal().toLocaleString()}</div>
  <Divider />
  <Title level={4}>
    Tá»•ng cá»™ng: {calculateTotal().toLocaleString()} VNÄ
  </Title>
</Card>
```

## Helper Functions

### addToCart
```tsx
const addToCart = (product: any, pricing: any) => {
  const existingItem = cart.find(
    item => item.product_id === product.id && 
            item.billing_cycle === pricing.cycle
  );

  if (existingItem) {
    // Increase quantity
    setCart(cart.map(item =>
      item.product_id === product.id && 
      item.billing_cycle === pricing.cycle
        ? { ...item, qty: item.qty + 1 }
        : item
    ));
  } else {
    // Add new item
    const newItem: CartItem = {
      product_id: product.id,
      product_name: product.name,
      product_type: product.type,
      billing_cycle: pricing.cycle,
      billing_cycle_display: pricing.cycle_display,
      unit_price: pricing.price,
      setup_fee: pricing.setup_fee || 0,
      qty: 1,
      description: `${product.name} - ${pricing.cycle_display}`,
    };
    setCart([...cart, newItem]);
  }
  message.success('ÄÃ£ thÃªm vÃ o giá» hÃ ng');
};
```

### removeFromCart
```tsx
const removeFromCart = (index: number) => {
  setCart(cart.filter((_, i) => i !== index));
};
```

### updateCartItemQty
```tsx
const updateCartItemQty = (index: number, qty: number) => {
  if (qty < 1) return;
  setCart(cart.map((item, i) => 
    i === index ? { ...item, qty } : item
  ));
};
```

### calculateSubtotal & calculateTotal
```tsx
const calculateSubtotal = () => {
  return cart.reduce((sum, item) => 
    sum + (item.unit_price * item.qty) + item.setup_fee, 0
  );
};

const calculateTotal = () => {
  return calculateSubtotal(); // Can add tax here
};
```

### resetCreateForm
```tsx
const resetCreateForm = () => {
  setCart([]);
  setSelectedUserId(null);
  setDueDate(null);
  setNotes('');
  setProductSearchText('');
};
```

## Submit Handler

```tsx
const handleCreateInvoice = async () => {
  try {
    const items = cart.map(item => ({
      product_id: item.product_id,
      description: item.description,
      type: 'product',
      billing_cycle: item.billing_cycle,
      qty: item.qty,
      unit_price: item.unit_price,
      setup_fee: item.setup_fee || 0,
    }));

    const payload = {
      user_id: selectedUserId,
      items: items,
      due_date: dueDate ? dayjs(dueDate).format('YYYY-MM-DD') : null,
      notes: notes || null,
    };

    await axios.post('/aio/api/whmcs/invoices', payload);
    message.success('Táº¡o hÃ³a Ä‘Æ¡n thÃ nh cÃ´ng');
    setIsCreateDrawerOpen(false);
    resetCreateForm();
    fetchInvoices();
  } catch (error: any) {
    message.error(error.response?.data?.message || 'KhÃ´ng thá»ƒ táº¡o hÃ³a Ä‘Æ¡n');
  }
};
```

## Responsive Behavior

### Desktop (â‰¥ 992px)
- Drawer width: 90%
- 2 columns: 60% products / 40% order
- Both columns scrollable

### Tablet (768px - 991px)
- Drawer width: 90%
- 2 columns stacked
- Vertical scroll

### Mobile (< 768px)
- Drawer width: 100%
- 1 column layout
- Products first, order info below

```tsx
<Col xs={24} lg={14}>  {/* xs=24 stacks on mobile, lg=14 is 60% on desktop */}
<Col xs={24} lg={10}>  {/* xs=24 stacks on mobile, lg=10 is 40% on desktop */}
```

## UX Improvements

### Before (Old Form)
- âŒ Select product from dropdown (hard to browse)
- âŒ Manual input pricing
- âŒ No preview of total
- âŒ Can't see all products at once
- âŒ Confusing form layout

### After (New Drawer)
- âœ… Browse all products visually
- âœ… Search products easily
- âœ… Click to add (shopping cart pattern)
- âœ… Real-time total calculation
- âœ… Clear 2-column separation
- âœ… Professional POS-like interface

## Performance

### Optimizations
- Product filter with useMemo
- Debounced search (optional)
- Virtual scroll for long product lists (optional)
- Lazy load product images (future)

## Files Changed

1. `resources/js/pages/whmcs/InvoiceList.tsx`
   - Added CartItem interface
   - Added cart state management
   - Added addToCart, removeFromCart, updateCartItemQty
   - Added calculateSubtotal, calculateTotal
   - Replaced Modal/Form with new Drawer layout

## Related Docs

- WHMCS_INVOICE_MOBILE_OPTIMIZATION.md
- WHMCS_INVOICE_ACTIONS_DROPDOWN.md
- WHMCS_INVOICE_EDIT_FEATURE.md

---
**Updated**: 12/11/2025  
**Type**: Major UX Improvement - Shopping Cart Pattern  
**Width**: 90% Drawer  
**Layout**: 60% Products / 40% Order Info
